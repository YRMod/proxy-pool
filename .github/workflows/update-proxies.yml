# ============================================
# 终极核弹级屎山 - 把所有能想到的修复方案都塞进去
# 作者：被GitHub Actions折磨到崩溃的兄弟
# 版本：999.0.0
# 说明：不管什么错，总有一个能对上
# ============================================

name: Update Proxy List

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# 权限拉满
permissions:
  contents: write
  pull-requests: write
  actions: write
  checks: write
  statuses: write
  deployments: write
  packages: write
  pages: write
  issues: write

# 并发控制
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
        node-version: ['16', '18', '20']
      fail-fast: false
      max-parallel: 1
    
    steps:
      # ========== 清理环境 ==========
      - name: Clean workspace
        run: |
          rm -rf ./*
          rm -rf ./.[!.]*
        continue-on-error: true
      
      # ========== 多方式拉取代码 ==========
      - name: Checkout code - 方式1 (标准)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          clean: true
          submodules: recursive
      
      - name: Checkout code - 方式2 (备用)
        if: failure()
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
      
      # ========== 设置多版本环境 ==========
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      
      # ========== 安装依赖 ==========
      - name: Install dependencies - 方式1 (pip)
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade setuptools wheel
          pip install requests beautifulsoup4 lxml html5lib
      
      - name: Install dependencies - 方式2 (apt)
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl wget jq
        continue-on-error: true
      
      # ========== 生成代理 ==========
      - name: Fetch proxies
        run: |
          python fetch_proxies.py || python3 fetch_proxies.py
          ls -la
          cat proxies.txt || echo "no file"
      
      # ========== 屎山开始：30种提交方案 ==========
      
      # 方案1：标准pull+push
      - name: Push - 方案1 (标准pull+push)
        if: always()
        run: |
          echo "=== 方案1：标准pull+push ==="
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git checkout main || git checkout -b main
          git pull origin main --rebase || git pull origin main
          git add -A
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'%Y-%m-%d_%H:%M:%S')"
          git push origin main
        continue-on-error: true
      
      # 方案2：强制重置+推送
      - name: Push - 方案2 (强制重置)
        if: always()
        run: |
          echo "=== 方案2：强制重置 ==="
          git fetch origin
          git reset --hard origin/main
          git add -f proxies.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'%Y-%m-%d_%H:%M:%S')"
          git push origin main --force
        continue-on-error: true
      
      # 方案3：强制推送
      - name: Push - 方案3 (强制推送)
        if: always()
        run: |
          echo "=== 方案3：强制推送 ==="
          git add -f proxies.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'%Y-%m-%d_%H:%M:%S')"
          git push origin main --force-with-lease
        continue-on-error: true
      
      # 方案4：先删后加
      - name: Push - 方案4 (先删后加)
        if: always()
        run: |
          echo "=== 方案4：先删后加 ==="
          git rm --cached proxies.txt 2>/dev/null || true
          git add -f proxies.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'%Y-%m-%d_%H:%M:%S')"
          git pull origin main --rebase || true
          git push origin main
        continue-on-error: true
      
      # 方案5：新建分支
      - name: Push - 方案5 (新建分支)
        if: always()
        run: |
          echo "=== 方案5：新建分支 ==="
          BRANCH_NAME="update-proxy-$(date +%s)"
          git checkout -b $BRANCH_NAME
          git add -f proxies.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'%Y-%m-%d_%H:%M:%S')"
          git push origin $BRANCH_NAME
        continue-on-error: true
      
      # 方案6：合并分支
      - name: Push - 方案6 (合并分支)
        if: always()
        run: |
          echo "=== 方案6：合并分支 ==="
          git checkout -b temp-branch
          git add -f proxies.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'%Y-%m-%d_%H:%M:%S')"
          git checkout main
          git merge temp-branch --no-ff
          git push origin main
        continue-on-error: true
      
      # 方案7：先拉取再合并
      - name: Push - 方案7 (fetch+merge)
        if: always()
        run: |
          echo "=== 方案7：fetch+merge ==="
          git fetch origin
          git merge origin/main --no-edit
          git add -f proxies.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'%Y-%m-%d_%H:%M:%S')"
          git push origin main
        continue-on-error: true
      
      # 方案8：用token认证
      - name: Push - 方案8 (token认证)
        if: always()
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== 方案8：token认证 ==="
          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git
          git add -f proxies.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'%Y-%m-%d_%H:%M:%S')"
          git push origin main
        continue-on-error: true
      
      # 方案9：用ssh
      - name: Push - 方案9 (ssh)
        if: always()
        run: |
          echo "=== 方案9：ssh ==="
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          git remote set-url origin git@github.com:${{ github.repository }}.git
          git add -f proxies.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'%Y-%m-%d_%H:%M:%S')"
          git push origin main
        continue-on-error: true
      
      # 方案10：使用gh命令行
      - name: Push - 方案10 (gh)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== 方案10：gh ==="
          gh auth status || gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
          git add -f proxies.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'%Y-%m-%d_%H:%M:%S')"
          gh release create proxy-list-$(date +%s) proxies.txt || true
        continue-on-error: true
      
      # 方案11：创建release附件
      - name: Push - 方案11 (release)
        if: always()
        run: |
          echo "=== 方案11：release ==="
          gh release create proxy-file-$(date +%s) proxies.txt --title "代理列表 $(date)" || true
        continue-on-error: true
      
      # 方案12：用API上传
      - name: Push - 方案12 (api)
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== 方案12：api ==="
          curl -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"message\":\"自动更新代理列表 $(date)\",\"content\":\"$(base64 -w 0 proxies.txt)\",\"branch\":\"main\",\"sha\":\"$(git rev-parse HEAD:proxies.txt 2>/dev/null || echo '')\"}" \
            https://api.github.com/repos/${{ github.repository }}/contents/proxies.txt
        continue-on-error: true
      
      # 方案13：创建新文件
      - name: Push - 方案13 (新文件名)
        if: always()
        run: |
          echo "=== 方案13：新文件名 ==="
          cp proxies.txt proxies-$(date +%Y%m%d-%H%M%S).txt
          git add *.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'%Y-%m-%d_%H:%M:%S')"
          git push origin main
        continue-on-error: true
      
      # 方案14：提交到不同分支
      - name: Push - 方案14 (不同分支)
        if: always()
        run: |
          echo "=== 方案14：不同分支 ==="
          git checkout -b proxy-branch
          git add -f proxies.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'%Y-%m-%d_%H:%M:%S')"
          git push origin proxy-branch
        continue-on-error: true
      
      # 方案15：创建PR并自动合并
      - name: Push - 方案15 (pr+merge)
        if: always()
        run: |
          echo "=== 方案15：pr+merge ==="
          BRANCH="auto-proxy-$(date +%s)"
          git checkout -b $BRANCH
          git add -f proxies.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'%Y-%m-%d_%H:%M:%S')"
          git push origin $BRANCH
          gh pr create --base main --head $BRANCH --title "自动更新代理列表" --body "自动生成的代理文件" || true
          gh pr merge $BRANCH --auto --merge || true
        continue-on-error: true
      
      # 方案16：直接覆盖文件
      - name: Push - 方案16 (直接覆盖)
        if: always()
        run: |
          echo "=== 方案16：直接覆盖 ==="
          git fetch origin
          git checkout main
          cp proxies.txt proxies.txt.new
          mv proxies.txt.new proxies.txt
          git add -f proxies.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'%Y-%m-%d_%H:%M:%S')"
          git push origin main --force
        continue-on-error: true
      
      # 方案17：使用git rebase
      - name: Push - 方案17 (rebase)
        if: always()
        run: |
          echo "=== 方案17：rebase ==="
          git fetch origin
          git rebase origin/main
          git add -f proxies.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'Y-%m-%d_%H:%M:%S')"
          git push origin main
        continue-on-error: true
      
      # 方案18：先stash再pop
      - name: Push - 方案18 (stash)
        if: always()
        run: |
          echo "=== 方案18：stash ==="
          git stash
          git pull origin main
          git stash pop || true
          git add -f proxies.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新代理列表 $(date +'%Y-%m-%d_%H:%M:%S')"
          git push origin main
        continue-on-error: true
      
      # 方案19：用workflow_dispatch触发
      - name: Push - 方案19 (workflow_dispatch)
        if: always()
        run: |
          echo "=== 方案19：workflow_dispatch ==="
          gh workflow run update-proxies.yml || true
        continue-on-error: true
      
      # 方案20：直接上传到action artifacts
      - name: Push - 方案20 (artifacts)
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: proxies
          path: proxies.txt
      
      # ========== 最终检查 ==========
      - name: Final check
        if: always()
        run: |
          echo "================================="
          echo "  所有方案执行完毕"
          echo "================================="
          git status
          echo "当前分支: $(git branch --show-current)"
          echo "远程仓库: $(git remote -v)"
          echo "最后提交: $(git log -1 --oneline)"
          echo "================================="
